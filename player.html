
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnGram Secure Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }
        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .blur-overlay {
            display: none;
            backdrop-filter: blur(12px);
            background: rgba(15, 23, 42, 0.9);
        }
        .blur-overlay.active {
            display: flex;
        }
        .timer-glow {
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="app" class="relative h-full flex flex-col">
        <!-- Global Header Ad Placeholder -->
        <div id="header-ad-player" class="w-full flex justify-center bg-transparent min-h-[1px] overflow-visible relative z-50"></div>

        <!-- Focus Warning Overlay -->
        <div id="warning-overlay" class="blur-overlay fixed inset-0 z-50 flex-col items-center justify-center text-center p-6 transition-all duration-300">
            <div class="bg-slate-800 p-8 rounded-3xl border-2 border-red-500 shadow-2xl shadow-red-500/20 max-w-xs scale-in">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h1 class="text-2xl font-black text-white uppercase tracking-tighter mb-2">STRIKE ALERT</h1>
                <p class="text-slate-400 text-sm mb-6">You left the secure zone. The timer is paused. Return now to avoid a ban!</p>
                <div class="animate-bounce text-blue-400 font-bold">Waiting for focus...</div>
            </div>
        </div>

        <!-- Video Player Section -->
        <div class="flex-1 bg-black relative video-container" id="player-slot">
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-10">
                <div class="loader mb-4"></div>
                <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest animate-pulse">Loading Secure Stream...</p>
            </div>
            
            <!-- Fallback Message (Hidden by default) -->
            <div id="fallback-zone" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 bg-slate-900 z-20">
                <div class="text-6xl mb-4">üö´</div>
                <h3 class="text-xl font-bold text-white mb-2">Content cannot be displayed here.</h3>
                <p class="text-slate-400 text-sm mb-8">Click the button below to watch on the official app and return here to claim.</p>
                <a id="official-link" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-500 px-10 py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl shadow-blue-600/20 transition-all active:scale-95">
                    Watch on App
                </a>
            </div>
        </div>

        <!-- Control Bar -->
        <div class="bg-slate-900 border-t border-slate-800 p-4 flex flex-col items-center gap-4">
            <div id="timer-box" class="flex items-center gap-3 bg-slate-800 px-6 py-2 rounded-2xl border border-slate-700">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Remaining</span>
                <span id="timer-display" class="text-2xl font-black text-blue-400 font-mono timer-glow">00:00</span>
            </div>

            <!-- Captcha Section (Hidden initially) -->
            <div id="captcha-box" class="hidden w-full max-w-xs animate-in slide-in-from-bottom duration-500">
                <div class="bg-blue-600/10 border border-blue-500/30 p-4 rounded-2xl text-center space-y-3">
                    <p class="text-xs font-bold text-blue-400 uppercase">Solve to Claim Reward</p>
                    <div class="flex items-center justify-center gap-3">
                        <span id="math-problem" class="text-xl font-bold">5 + 3 = ?</span>
                        <input type="number" id="captcha-input" class="w-20 bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-center font-bold focus:border-blue-500 outline-none" placeholder="?">
                    </div>
                    <button id="claim-btn" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition-all shadow-lg shadow-blue-600/20">
                        Claim Reward
                    </button>
                </div>
            </div>

            <!-- Global Footer Ad Placeholder -->
            <div id="footer-ad-player" class="w-full flex justify-center bg-transparent min-h-[1px] overflow-visible relative z-50 mt-2"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let videoUrl = urlParams.get('url');
        const headerAdScript = urlParams.get('headerAd');
        const footerAdScript = urlParams.get('footerAd');
        let timeLeft = parseInt(urlParams.get('time')) || 60;
        
        const timerDisplay = document.getElementById('timer-display');
        const warningOverlay = document.getElementById('warning-overlay');
        const playerSlot = document.getElementById('player-slot');
        const captchaBox = document.getElementById('captcha-box');
        const timerBox = document.getElementById('timer-box');
        const mathProblem = document.getElementById('math-problem');
        const captchaInput = document.getElementById('captcha-input');
        const claimBtn = document.getElementById('claim-btn');
        const fallbackZone = document.getElementById('fallback-zone');
        const officialLink = document.getElementById('official-link');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Force HTTPS
        if (videoUrl && videoUrl.startsWith('http://')) {
            videoUrl = videoUrl.replace('http://', 'https://');
        }

        // 0. Inject Ads
        function injectAds() {
            if (headerAdScript) {
                const container = document.getElementById('header-ad-player');
                const range = document.createRange();
                const fragment = range.createContextualFragment(headerAdScript);
                container.appendChild(fragment);
            }
            if (footerAdScript) {
                const container = document.getElementById('footer-ad-player');
                const range = document.createRange();
                const fragment = range.createContextualFragment(footerAdScript);
                container.appendChild(fragment);
            }
        }
        injectAds();

        let isPaused = false;
        let captchaAnswer = 0;

        // 1. Detect Platform & Embed
        function initPlayer() {
            if (!videoUrl) {
                playerSlot.innerHTML = '<div class="flex items-center justify-center h-full text-red-500">Invalid URL</div>';
                loadingSpinner.classList.add('hidden');
                return;
            }

            const platform = urlParams.get('platform');
            let embedHtml = '';
            const allowAttr = "autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen";

            // Aggressive YouTube Conversion
            if (platform === 'YouTube' || videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = videoUrl.match(regExp);
                const id = (match && match[2].length === 11) ? match[2] : '';
                if (id) {
                    // Force Professional Embed with origin
                    embedHtml = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0&showinfo=0&origin=https://earn-gram-bot.onrender.com" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
                }
            } 
            // Aggressive Dailymotion Conversion
            else if (platform === 'Dailymotion' || videoUrl.includes('dailymotion.com') || videoUrl.includes('dai.ly')) {
                let id = '';
                if (videoUrl.includes('dai.ly')) {
                    const parts = videoUrl.split('/');
                    id = parts[parts.length - 1].split('?')[0];
                } else {
                    id = videoUrl.split('/video/')[1]?.split('?')[0];
                }
                if (id) {
                    // Force Professional Embed
                    embedHtml = `<iframe src="https://www.dailymotion.com/embed/video/${id}?autoplay=1&mute=1" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
                }
            }
            // TikTok
            else if (platform === 'TikTok' || videoUrl.includes('tiktok.com')) {
                const id = videoUrl.split('/video/')[1]?.split('?')[0];
                if (id) {
                    embedHtml = `<iframe src="https://www.tiktok.com/embed/v2/${id}" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
                }
            } 
            // Vimeo
            else if (platform === 'Vimeo' || videoUrl.includes('vimeo.com')) {
                const id = videoUrl.split('/').pop()?.split('?')[0];
                if (id) {
                    embedHtml = `<iframe src="https://player.vimeo.com/video/${id}?autoplay=1&muted=0" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
                }
            } 
            // Facebook
            else if (platform === 'Facebook' || videoUrl.includes('facebook.com')) {
                embedHtml = `<iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(videoUrl)}&show_text=0&autoplay=1" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
            } 
            // Custom MP4
            else if (platform === 'Custom' || videoUrl.endsWith('.mp4')) {
                embedHtml = `<video src="${videoUrl}" autoplay controls class="w-full h-full" oncontextmenu="return false;" controlsList="nodownload" onloadeddata="document.getElementById('loading-spinner').classList.add('hidden')"></video>`;
            } 
            // Generic Fallback
            else {
                embedHtml = `<iframe src="${videoUrl}" allow="${allowAttr}" onload="document.getElementById('loading-spinner').classList.add('hidden')"></iframe>`;
            }

            if (embedHtml) {
                playerSlot.innerHTML += embedHtml;
            } else {
                showFallback();
            }
        }

        function showFallback() {
            fallbackZone.classList.remove('hidden');
            officialLink.href = videoUrl;
            loadingSpinner.classList.add('hidden');
        }

        // 2. Timer Logic
        const countdown = setInterval(() => {
            if (!isPaused && timeLeft > 0) {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (timeLeft === 0) {
                    clearInterval(countdown);
                    showCaptcha();
                }
            }
        }, 1000);

        // 3. Focus Monitoring (Strike System)
        window.onblur = () => {
            isPaused = true;
            warningOverlay.classList.add('active');
            window.parent.postMessage({ type: 'FOCUS_LOST' }, '*');
        };

        window.onfocus = () => {
            isPaused = false;
            warningOverlay.classList.remove('active');
            window.parent.postMessage({ type: 'FOCUS_GAINED' }, '*');
        };

        // 4. Captcha Implementation
        function showCaptcha() {
            timerBox.classList.add('hidden');
            captchaBox.classList.remove('hidden');
            
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaAnswer = num1 + num2;
            mathProblem.innerText = `${num1} + ${num2} = ?`;
            
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }

        // 5. Completion Signal
        claimBtn.onclick = () => {
            const userVal = parseInt(captchaInput.value);
            if (userVal === captchaAnswer) {
                // Prevent multiple clicks
                claimBtn.disabled = true;
                claimBtn.innerText = 'Claiming...';
                
                window.parent.postMessage({ type: 'CLAIM_TASK' }, '*');
                
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.sendData(JSON.stringify({
                        status: 'success',
                        task_url: videoUrl
                    }));
                }
            } else {
                alert('Wrong answer! Try again.');
                showCaptcha();
                captchaInput.value = '';
            }
        };

        initPlayer();
    </script>
</body>
</html>
